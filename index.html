<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ranking FCDEX</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/861/861512.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
body.dark{background:#121212;color:#fff}
header{background:#fff;padding:15px;text-align:center;font-size:20px;font-weight:bold}
body.dark header{background:#1e1e1e}

.top-bar{display:flex;gap:10px;padding:10px}
input,select{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc}
button{padding:10px;border-radius:8px;border:none;cursor:pointer}

.card{background:#fff;margin:10px;padding:15px;border-radius:12px;cursor:pointer}
body.dark .card{background:#1e1e1e}

.linha{display:flex;justify-content:space-between;font-weight:bold}

.badge{padding:4px 10px;border-radius:12px;font-size:12px;color:#fff}
.verde{background:green}
.amarelo{background:orange}
.vermelho{background:red}

.barra{height:8px;background:#ddd;border-radius:4px;margin-top:8px}
.barra span{display:block;height:100%;border-radius:4px}

.detalhes{display:none;padding:15px}
.voltar{color:#0066cc;cursor:pointer;margin-bottom:10px}

.menu{
 position:fixed;
 bottom:0;
 width:100%;
 display:flex;
 background:#fff;
 border-top:1px solid #ccc
}
body.dark .menu{background:#1e1e1e}
.menu button{flex:1}

/* MODAL */
.modal-bg{
 display:none;
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.6);
 justify-content:center;
 align-items:center
}
.modal{
 background:#fff;
 padding:20px;
 border-radius:12px;
 width:90%;
 max-width:400px
}
body.dark .modal{background:#1e1e1e}
</style>
</head>

<body>

<header>üèÜ Ranking FCDEX</header>

<div class="top-bar" id="topBar">
  <input id="busca" placeholder="Buscar jogador..." onkeyup="filtrar()">
  <button onclick="toggleDark()">üåô</button>
</div>

<!-- TELAS -->
<div id="ranking"></div>
<div id="detalhes" class="detalhes"></div>
<div id="estatisticas" style="display:none"></div>

<div id="jogos" style="display:none">
  <div class="top-bar">
    <select id="filtroRodada" onchange="filtrarRodada()">
      <option value="todas">Todas as rodadas</option>
    </select>
  </div>
  <div id="listaJogos"></div>
</div>

<!-- MENU -->
<nav class="menu">
  <button onclick="mostrarTela('ranking')">üèÜ Ranking</button>
  <button onclick="mostrarTela('estatisticas')">üéØ Artilharia</button>
  <button onclick="mostrarTela('jogos')">üìÖ Jogos</button>
</nav>

<!-- MODAL -->
<div class="modal-bg" id="modalBg" onclick="fecharModal(event)">
  <div class="modal">
    <h3 id="modalTitulo"></h3>
    <p id="destaquePartida"></p>
    <hr>
    <p><strong>Casa:</strong> <span id="golsCasa"></span></p>
    <p><strong>Fora:</strong> <span id="golsFora"></span></p>
  </div>
</div>

<script>
const SHEET_ID="1axJMakPXrMPjsIfmJoMMXQ35qzND9_NnL7JdI6k_R5U";
const URLS={
 ranking:`https://opensheet.elk.sh/${SHEET_ID}/Desempenho por Jogador`,
 estatisticas:`https://opensheet.elk.sh/${SHEET_ID}/Estatisticas`,
 jogos:`https://opensheet.elk.sh/${SHEET_ID}/Jogos`
};

let jogadores=[],jogosLista=[],chart;

/* TELAS */
function mostrarTela(id){
 ["ranking","detalhes","estatisticas","jogos"].forEach(t=>{
  document.getElementById(t).style.display="none";
 });
 document.getElementById(id).style.display="block";
 topBar.style.display=id==="ranking"?"flex":"none";
}

/* RANKING */
fetch(URLS.ranking).then(r=>r.json()).then(d=>{
 jogadores=d.sort((a,b)=>parseFloat(b.Aproveitamento)-parseFloat(a.Aproveitamento));
 renderRanking(jogadores);
});

function badge(ap){return ap>=70?"verde":ap>=40?"amarelo":"vermelho"}

function renderRanking(lista){
 ranking.innerHTML="";
 lista.forEach((j,i)=>{
  const ap=parseFloat(String(j.Aproveitamento).replace("%","").replace(",","."))||0;
  ranking.innerHTML+=`
   <div class="card" onclick='mostrarDetalhes(${JSON.stringify(j)})'>
    <div class="linha">
     <span>${i+1}¬∫ ${j.Jogador}</span>
     <span class="badge ${badge(ap)}">${ap}%</span>
    </div>
    <div class="barra">
     <span style="width:${ap}%;background:${badge(ap)==="verde"?"green":badge(ap)==="amarelo"?"orange":"red"}"></span>
    </div>
   </div>`;
 });
}

function filtrar(){
 const t=busca.value.toLowerCase();
 renderRanking(jogadores.filter(j=>j.Jogador.toLowerCase().includes(t)));
}

/* DETALHES */
function mostrarDetalhes(j){
 mostrarTela("detalhes");
 detalhes.innerHTML=`
  <div class="voltar" onclick="mostrarTela('ranking')">‚Üê Voltar</div>
  <h2>${j.Jogador}</h2>
  <p>Jogos: ${j.Jogos}</p>
  <p>Vit√≥rias: ${j.Vit√≥ria}</p>
  <p>Empates: ${j.Empate}</p>
  <p>Derrotas: ${j.Derrota}</p>
  <canvas id="grafico" height="220"></canvas>`;
 gerarGrafico(j);
}

function gerarGrafico(j){
 const v=+j.Vit√≥ria||0,e=+j.Empate||0,d=+j.Derrota||0;
 let pontos=0,labels=[],dados=[];
 for(let i=1;i<=v+e+d;i++){
  if(i<=v) pontos+=3;
  else if(i<=v+e) pontos+=1;
  dados.push(((pontos/(i*3))*100).toFixed(1));
  labels.push("Jogo "+i);
 }
 if(chart) chart.destroy();
 chart=new Chart(grafico,{
  type:"line",
  data:{labels,datasets:[{
   data:dados,
   label:"Aproveitamento %",
   borderColor:"#4caf50",
   fill:true,
   tension:.4
  }]},
  options:{scales:{y:{min:0,max:100}}}
 });
}

/* ARTILHARIA */
fetch(URLS.estatisticas).then(r=>r.json()).then(d=>{
 estatisticas.innerHTML="<h2 style='margin:10px'>üéØ Artilharia</h2>";
 d.sort((a,b)=>b.Gols-a.Gols).forEach((j,i)=>{
  estatisticas.innerHTML+=`
   <div class="card">
    <div class="linha">
     <span>${i+1}¬∫ ${j.Jogador}</span>
     <strong>${j.Gols} ‚öΩ</strong>
    </div>
    <small>Jogos: ${j.Jogos} | M√©dia: ${j.Media}</small>
   </div>`;
 });
});

/* JOGOS */
fetch(URLS.jogos).then(r=>r.json()).then(d=>{
 jogosLista=d;
 montarFiltro();
 renderJogos(d);
});

function montarFiltro(){
 [...new Set(jogosLista.map(j=>j.Rodada))].forEach(r=>{
  filtroRodada.innerHTML+=`<option value="${r}">Rodada ${r}</option>`;
 });
}

function filtrarRodada(){
 const r=filtroRodada.value;
 renderJogos(r==="todas"?jogosLista:jogosLista.filter(j=>j.Rodada===r));
}

function renderJogos(lista){
 listaJogos.innerHTML="";
 lista.forEach(j=>{
  listaJogos.innerHTML+=`
   <div class="card" onclick="abrirModal(
     '${j.Time_Casa}',
     '${j.Time_Fora}',
     '${j.Artilharia_Casa}',
     '${j.Artilharia_Fora}'
   )">

    <strong>Rodada ${j.Rodada}</strong><br>
    <small>
      üìÖ ${j.Data || "Data a definir"} |
      ‚è∞ ${j.Hora || "--:--"}<br>
      üìç ${j.Local || "Local n√£o informado"}
    </small>

    <br><br>

    <div class="linha">
     <span>${j.Time_Casa}</span>
     <strong>${j.Gols_Casa} x ${j.Gols_Fora}</strong>
     <span>${j.Time_Fora}</span>
    </div>
   </div>`;
 });
}


function abrirModal(c,f,ac,af){
 modalTitulo.innerText=`${c} x ${f}`;
 golsCasa.innerText=ac||"Sem gols";
 golsFora.innerText=af||"Sem gols";
 destaquePartida.innerText=ac||af?"‚≠ê Destaque da partida":"";
 modalBg.style.display="flex";
}
function fecharModal(e){if(e.target===modalBg)modalBg.style.display="none"}

function toggleDark(){document.body.classList.toggle("dark")}
</script>

</body>
</html>
